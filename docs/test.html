<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TubeNova Test</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .test-box {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 30px;
      margin: 20px auto;
      max-width: 600px;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .info { color: #3b82f6; }
  </style>
</head>
<body>
  <div class="test-box text-white">
    <h1 class="text-3xl font-bold mb-6">üß™ TubeNova Backend Test</h1>
    
    <div class="mb-4">
      <label class="block mb-2">Backend URL:</label>
      <input type="text" id="backendUrl" 
             value="http://127.0.0.1:5000"
             class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-white"
             placeholder="http://127.0.0.1:5000">
    </div>
    
    <div class="mb-4">
      <label class="block mb-2">YouTube URL:</label>
      <input type="text" id="videoUrl" 
             value="https://www.youtube.com/watch?v=dQw4w9WgXcQ"
             class="w-full px-4 py-2 rounded-lg bg-white/10 border border-white/20 text-white"
             placeholder="Paste YouTube URL">
    </div>
    
    <button onclick="testHealth()" class="px-6 py-3 bg-green-500 hover:bg-green-600 rounded-lg font-bold mr-2 mb-2">
      Test Health
    </button>
    
    <button onclick="testInfo()" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 rounded-lg font-bold mr-2 mb-2">
      Test Info API
    </button>
    
    <button onclick="testFallback()" class="px-6 py-3 bg-purple-500 hover:bg-purple-600 rounded-lg font-bold mb-2">
      Test Fallback
    </button>
    
    <div id="results" class="mt-6 p-4 bg-black/30 rounded-lg min-h-32 font-mono text-sm overflow-auto max-h-96"></div>
  </div>

  <script src="fallback.js"></script>
  <script>
    function log(msg, type = 'info') {
      const results = document.getElementById('results');
      const span = document.createElement('div');
      span.className = type;
      span.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      results.appendChild(span);
      results.scrollTop = results.scrollHeight;
    }

    async function testHealth() {
      log('Testing backend health...', 'info');
      const backend = document.getElementById('backendUrl').value;
      
      try {
        const response = await fetch(`${backend}/api/health`);
        const data = await response.json();
        
        if (data.status === 'ok') {
          log('‚úÖ Backend is running!', 'success');
          log(JSON.stringify(data), 'info');
        } else {
          log('‚ö†Ô∏è Backend returned unexpected response', 'error');
          log(JSON.stringify(data), 'error');
        }
      } catch (error) {
        log('‚ùå Backend connection failed: ' + error.message, 'error');
        log('Make sure backend is running on ' + backend, 'info');
      }
    }

    async function testInfo() {
      log('Testing info API...', 'info');
      const backend = document.getElementById('backendUrl').value;
      const url = document.getElementById('videoUrl').value;
      
      if (!url) {
        log('‚ùå Please enter a YouTube URL', 'error');
        return;
      }
      
      try {
        const response = await fetch(`${backend}/api/info?url=${encodeURIComponent(url)}`);
        const data = await response.json();
        
        if (data.success && data.data) {
          log('‚úÖ Info API works!', 'success');
          log(`Title: ${data.data.title}`, 'info');
          log(`Uploader: ${data.data.uploader}`, 'info');
          log(`Duration: ${data.data.duration}s`, 'info');
          log(`Formats available: ${data.data.formats.length}`, 'info');
          log('Sample format: ' + JSON.stringify(data.data.formats[0] || {}), 'info');
        } else {
          log('‚ö†Ô∏è API returned unexpected format', 'error');
          log(JSON.stringify(data).substring(0, 500), 'error');
        }
      } catch (error) {
        log('‚ùå Info API failed: ' + error.message, 'error');
      }
    }

    async function testFallback() {
      log('Testing fallback mode (Invidious)...', 'info');
      const url = document.getElementById('videoUrl').value;
      
      if (!url) {
        log('‚ùå Please enter a YouTube URL', 'error');
        return;
      }
      
      try {
        if (!window.TubeNovaFallback) {
          log('‚ùå Fallback not loaded', 'error');
          return;
        }
        
        log('Fetching from Invidious API...', 'info');
        const result = await window.TubeNovaFallback.fetchInfoFallback(url);
        
        if (result.success && result.data) {
          log('‚úÖ Fallback works!', 'success');
          log(`Title: ${result.data.title}`, 'info');
          log(`Uploader: ${result.data.uploader}`, 'info');
          log(`Duration: ${result.data.duration}s`, 'info');
          log(`Formats available: ${result.data.formats.length}`, 'info');
          
          const videoFormats = result.data.formats.filter(f => f.type === 'video');
          const audioFormats = result.data.formats.filter(f => f.type === 'audio');
          log(`Video formats: ${videoFormats.length}`, 'info');
          log(`Audio formats: ${audioFormats.length}`, 'info');
          
          if (result.data.formats.length > 0) {
            log('Sample format: ' + JSON.stringify(result.data.formats[0]), 'info');
          }
        } else {
          log('‚ö†Ô∏è Fallback returned unexpected format', 'error');
          log(JSON.stringify(result).substring(0, 500), 'error');
        }
      } catch (error) {
        log('‚ùå Fallback failed: ' + error.message, 'error');
        log('Stack: ' + error.stack, 'error');
      }
    }

    // Auto-load on page load
    window.addEventListener('load', () => {
      log('üöÄ Test page loaded', 'success');
      log('Click buttons above to test functionality', 'info');
      
      if (window.TubeNovaFallback) {
        log('‚úÖ Fallback script loaded successfully', 'success');
      } else {
        log('‚ö†Ô∏è Fallback script not loaded', 'error');
      }
    });
  </script>
</body>
</html>
